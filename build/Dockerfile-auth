FROM docker.io/library/golang:1.14-alpine3.11 AS builddeps
COPY go.mod go.sum /go/src/github.com/mgoltzsche/credential-manager/
WORKDIR /go/src/github.com/mgoltzsche/credential-manager
RUN go mod download

FROM builddeps AS build
COPY . /go/src/github.com/mgoltzsche/credential-manager
RUN go build -ldflags '-s -w -extldflags "-static"' ./cmd/authservice && mv authservice /bin/

# Prepare authservice image
FROM alpine:3.11
COPY build/bin /usr/local/bin
ENV OPERATOR=/usr/local/bin/authservice \
    USER_UID=1002 \
    USER_NAME=authservice
RUN /usr/local/bin/user_setup
USER ${USER_UID}
ENTRYPOINT ["/usr/local/bin/entrypoint"]
COPY --from=build /bin/authservice ${OPERATOR}
